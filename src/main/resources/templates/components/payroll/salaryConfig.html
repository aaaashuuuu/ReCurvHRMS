<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<title>Salary Config</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<style>
body { background: #f8f9fa; }
.config-container { margin: 30px; padding: 20px; background: #fff; border-radius: 12px; box-shadow: 0 3px 8px rgba(0,0,0,0.1); }
.btn-add { background: #ff6f00; color: white; font-weight: bold; }
.btn-add:hover { background: #e65c00; }
.d-none { display: none !important; }
.modal-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index:1000; display:flex; align-items:center; justify-content:center; visibility:hidden; opacity:0; transition: opacity 0.3s ease, visibility 0.3s ease; }
.modal-overlay.show { visibility: visible; opacity: 1; }
.modal-box { background:white; padding:20px; border-radius:12px; width:420px; box-shadow:0 5px 15px rgba(0,0,0,0.3); }
.modal-header { display:flex; justify-content:space-between; align-items:center; }
.close-btn { border:none; background:transparent; font-size:20px; cursor:pointer; }
</style>
</head>
<body>
<div class="config-container">
    <div class="d-flex justify-content-between mb-3">
        <div>
            <select id="earningSelect" class="form-select d-inline w-auto me-2">
                <option value="" disabled selected hidden>Choose</option>
                <option value="earning">Earning</option>
                <option value="earningType">Earning Type</option>
            </select>
            <select id="deductionSelect" class="form-select d-inline w-auto">
                <option value="" disabled selected hidden>Choose</option>
                <option value="deduction">Deduction</option>
                <option value="deductionType">Deduction Type</option>
            </select>
        </div>
        <button id="addBtn" class="btn btn-add">Add Earning</button>
    </div>

    <div id="tableContainer">
        <table class="table table-bordered text-center align-middle">
            <thead class="table-light"><tr id="tableHeader"></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<!-- Modal -->
<div id="modalOverlay" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <h5 id="formTitle">Add</h5>
            <button class="close-btn" onclick="closeModal()">√ó</button>
        </div>
        <form id="dynamicForm">
            <div id="formFields"></div>
        </form>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
let currentType = "earning";

function capitalize(str){return str.charAt(0).toUpperCase() + str.slice(1);}
function openModal(){ $("#modalOverlay").addClass("show"); }
function closeModal(){ $("#modalOverlay").removeClass("show"); }

function loadTable(type){
    $.get("/payroll/list/" + type, function(data){
        let html = "";
        if(type==="earning" || type==="deduction"){
            let idField = (type==="earning") ? "id" : "id";
            data.forEach(row=>{
                html += `<tr>
                    <td>${row.id}</td>
                    <td>${row.typeName}</td>
                    <td>${row.percentage}</td>
                    <td>${row.departmentName}</td>
                    <td>${row.designationName}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary editBtn" data-type="${type}" data-id="${row.id}">‚úè</button>
                        <button class="btn btn-sm btn-outline-danger deleteBtn" data-type="${type}" data-id="${row.id}">üóë</button>
                    </td>
                </tr>`;
            });
            $("#tableHeader").html(`<th>ID</th><th>${capitalize(type)} Type</th><th>Percentage</th><th>Department</th><th>Designation</th><th>Action</th>`);
        } else {
            data.forEach(row=>{
                const id = row.earningTypeId || row.deductionTypeId;
                const name = row.earningTypeName || row.deductionTypeName;
                html += `<tr>
                    <td>${id}</td>
                    <td>${name}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary editBtn" data-type="${type}" data-id="${id}">‚úè</button>
                        <button class="btn btn-sm btn-outline-danger deleteBtn" data-type="${type}" data-id="${id}">üóë</button>
                    </td>
                </tr>`;
            });
            $("#tableHeader").html("<th>ID</th><th>Name</th><th>Action</th>");
        }
        $("#tableBody").html(html);
    });
}

function loadDropdown(url, selectElem, selected){
    $.get(url,function(data){
        $(selectElem).html('<option value="">Select</option>');
        data.forEach(d=>{
            let val = d.departmentId || d.designationId || d.earningTypeId || d.deductionTypeId;
            let name = d.departmentName || d.designationName || d.earningTypeName || d.deductionTypeName;
            $(selectElem).append(`<option value="${val}">${name}</option>`);
        });
        if(selected) $(selectElem).val(selected);
    });
}

function buildModal(type, data={}){
    $("#formFields").html("");
    let html = "";

    if(type==="earning" || type==="deduction"){
        const idValue = data.id || "";
        const typeId = data.typeId || "";
        const deptId = data.departmentId || "";
        const desigId = data.designationId || "";
        const percentage = data.percentage || "";

        html += `
            <input type="hidden" name="id" value="${idValue}">
            <label>${capitalize(type)} Type</label>
            <select class="form-select mb-2" name="typeId" required></select>
            <input type="number" class="form-control mb-2" name="percentage" placeholder="Percentage" value="${percentage}" required>
            <select class="form-select mb-2" name="departmentId" required></select>
            <select class="form-select mb-2" name="designationId" required></select>
            <button class="btn btn-success w-100" type="submit">${idValue ? "Update" : "Save"}</button>
        `;
        $("#formFields").html(html);

        const typeUrl = (type === "earning") ? "/payroll/list/earningType" : "/payroll/list/deductionType";
        loadDropdown(typeUrl, "[name='typeId']", typeId);
        loadDropdown("/payroll/department/list", "[name='departmentId']", deptId);

        function loadDesignations(departmentId){
            $.get("/payroll/designation/getByDepartment?deptId=" + departmentId, function(desigs){
                let sel = $("[name='designationId']");
                sel.html('<option value="">Select</option>');
                desigs.forEach(d=>sel.append(`<option value="${d.designationId}">${d.designationName}</option>`));
                sel.val(desigId);
            });
        }

        if(deptId) loadDesignations(deptId);

        $("[name='departmentId']").off("change").on("change", function(){
            loadDesignations(this.value);
        });

    } else { // earningType or deductionType
        const idValue = data.earningTypeId || data.deductionTypeId || "";
        const nameValue = data.earningTypeName || data.deductionTypeName || "";

        html += `
            <input type="hidden" name="id" value="${idValue}">
            <input type="text" name="name" class="form-control mb-2" placeholder="Name" value="${nameValue}" required>
            <button class="btn btn-success w-100" type="submit">${idValue ? "Update" : "Save"}</button>
        `;
        $("#formFields").html(html);
    }
    
    
}

$("#earningSelect").change(function(){
    currentType = $(this).val();
    $("#deductionSelect").val("");
    $("#addBtn").text("Add " + capitalize(currentType));
    loadTable(currentType);
});
$("#deductionSelect").change(function(){
    currentType = $(this).val();
    $("#earningSelect").val("");
    $("#addBtn").text("Add " + capitalize(currentType));
    loadTable(currentType);
});

$("#addBtn").click(function(){
    buildModal(currentType, {});
    $("#formTitle").text("Add " + capitalize(currentType));
    openModal();
});

$("#dynamicForm").off("submit").on("submit", function(e){
    e.preventDefault();
    let payload = {};
    $(this).serializeArray().forEach(({name, value}) => {
        if(name === "id") {
            if(value && value.trim() !== "") payload.id = parseInt(value);
        }
        else if(["typeId","departmentId","designationId"].includes(name)) {
            payload[name] = parseInt(value);
        }
        else if(name==="percentage") {
            payload[name] = parseFloat(value);
        }
        else {
            payload[name] = value;
        }
    });

    $.ajax({
        url: "/payroll/save/" + currentType,
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify(payload),
        success: () => {
            alert("Saved successfully");
            closeModal();
            loadTable(currentType);
        },
        error: (xhr) => alert("Error saving data: " + xhr.responseText)
    });
});


$(document).on("click", ".editBtn", function(){
    const type = $(this).data("type");
    const id = $(this).data("id");
    $.get("/payroll/list/" + type, function(data){
        let item = data.find(el => el.id === id || el.earningTypeId === id || el.deductionTypeId === id);
        buildModal(type, item);
        $("#formTitle").text("Edit " + capitalize(type));
        openModal();
        currentType = type;
        $("#addBtn").text("Add " + capitalize(type));
    });
});

$(document).on("click", ".deleteBtn", function(){
    if(!confirm("Delete this record?")) return;
    const type = $(this).data("type");
    const id = $(this).data("id");
    $.ajax({
        url: "/payroll/delete/" + type + "/" + id,
        type: "DELETE",
        success: () => {
            alert("Deleted successfully");
            loadTable(type);
        },
        error: () => alert("Error deleting record")
    });
});

$("#modalOverlay").click(e => { if(e.target === e.currentTarget) closeModal(); });

// Initial load
loadTable(currentType);
$("#addBtn").text("Add " + capitalize(currentType));
</script>

</body>
</html>
